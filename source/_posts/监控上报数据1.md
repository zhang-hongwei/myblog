---
title: 前端监控数据上报方式（一）- image
date: 2019-06-10 22:00:00
tags: 前端监控
---

# image

## 使用image上报数据

### 为什么使用GIF进行数据上报

1.  **没有跨域问题；** 
    
    HTML5 给 <img> 标签新增加了一个 crossOrigin 属性，这个属性决定了图片获取过程中是否开启跨域功能。并且如果设置了 crossOrigin 这个属性，image 请求中将不带 cookie。代码示例如下：
    
    ```jsx
    // 浏览器端设置：
    var img = new Image();
    img.crossOrigin = "anonymous
    
    // 服务端设置：
    set('Access-Control-Allow-Origin', '*');
    ```
    
![](https://s2.loli.net/2023/09/05/hxfyPgUBjStNldV.png)
    
    设置了 crossOrigin = “anonymous” 的结果如图
    
![](https://s2.loli.net/2023/09/05/Jx9av7qonjBkz6E.png)
    
    未设置 crossOrigin = “anonymous”
    
    如果 canvas 加载了不同域的图片，就会变成被污染的画布，此时为了安全考虑，就不能再使用 getImageData()、toBlob()、toDataURL() 方法了。使用 crossOrigin 时，可以设置资源按照 CORS 来请求，这样 canvas 就不会识别出资源的跨域问题。
    
2. **不会阻塞页面加载，影响用户体验；** 
3. **在所有图片中体积最小，相较BMP/PNG，可以节约41%/35%的网络资源**。
    
    同样都是图片，上报时选用了1x1的透明GIF，而不是其他的PNG/JEPG/BMP文件
    
    1x1像素是最小的合法图片。而且，因为是通过图片打点，所以图片最好是透明的，这样一来不会影响页面本身展示效果，二者表示图片透明只要使用一个二进制位标记图片是透明色即可，不用存储色彩空间数据，可以节约体积。因为需要透明色，所以可以直接排除JEPG(BMP32格式可以支持透明色)。最小的BMP文件需要74个字节，PNG需要67个字节，而合法的GIF，只需要43个字节。
    

## 为什么不能直接用GET/POST/HEAD请求接口进行上报？

这个比较容易想到原因。一般而言，打点域名都不是当前域名，所以所有的接口请求都会构成跨域。而跨域请求很容易出现由于配置不当被浏览器拦截并报错，这是不能接受的。所以，直接排除。

## 为什么不能用请求其他的文件资源（js/css/ttf）的方式进行上报？

这和浏览器的特性有关。通常，创建资源节点后只有将对象注入到浏览器DOM树后，浏览器才会实际发送资源请求。反复操作DOM不仅会引发性能问题，而且载入js/css资源还会阻塞页面渲染，影响用户体验。

但是图片请求例外。构造图片打点不仅不用插入DOM，只要在js中new出Image对象就能发起请求，而且还没有阻塞问题，在没有js的浏览器环境中也能通过img标签正常打点，这是其他类型的资源请求所做不到的。

所以，在所有通过请求文件资源进行打点的方案中，使用图片是最好的解决方案。

## 缺点

1. 关闭页面时发送数据效果较差；
2. 对上报的数据量有一定的限制，一般为 2~8 kb；
3. 很容易被一些浏览器图片加载器拦截

## 代码实现